#!/usr/bin/env zsh

# small shellscript to cd into your git tree and update it.

if [ "$1" = "--help" ]; then
	echo "update-configurations 0.1"
	echo
	echo "small shellscript to update your configurations git tree."
	echo
	exit 0
fi

if [ "$1" = "-f" ]; then
	echo "Do you *REALLY* know what '-f' does?"
	echo
	echo "This will REMOVE all your local uncommitted changes and force an upgrade."
	echo
	echo -n "Enter YES to continue: "
	read VAR
	if [ ! "$VAR" = "YES" ]; then
		exit 1;
	fi
	FORCE=YES
fi

if [ ! -e ~/bin ]; then
	echo "ERROR: you do not have a ~/bin symlink!" >&2
	exit 1
fi

RDLNK=""
if which readlink >/dev/null 2>&1; then
	RDLNK=readlink
elif which greadlink >/dev/null 2>&1; then
	RDLNK=greadlink
fi

if [ -z "$RDLNK" ]; then
	echo "ERROR: Your System is missing the readlink command" >&2
	exit 2
fi

git_tree=$($RDLNK ~/bin)

if [ -z "$git_tree" ]; then
	echo "ERROR: ~/bin is not a symlink!" >&2
	exit 3
fi

cd $git_tree/..
echo "Updating..."

head=$(git symbolic-ref HEAD)
head=${head/#refs\/heads\//}

case $head in
	master)
		if [ "$FORCE" ]; then
			git reset --hard
		fi

		if git pull; then
			make QUIET=1
		fi
		;;
	*)
		echo "Current branch: $head"
		# First, figure out the merge branch, via git config.
		remote=$(git config --get branch.$head.remote)
		if [ ! -z "$remote" ]; then
			echo "Using remote $remote."
		elif [ -e .git/remotes/$head ] || git remote | grep -q $head; then
			remote=$head
			echo "Using remote $remote."
		else
			echo "Could not figure out remote. Aborting." >&2
			exit 3
		fi

		if [ "$FORCE" ]; then
			git reset --hard
		fi

		if git pull $remote; then
			make QUIET=1
		fi
		;;
esac

echo "update done."
exit 0


